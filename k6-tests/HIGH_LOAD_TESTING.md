# 고부하 WebSocket 테스트 가이드

이 문서는 채팅 애플리케이션의 WebSocket 부하 테스트를 위한 가이드입니다. 특히 10,000명 이상의 동시 사용자를 시뮬레이션하기 위한 최적화된 접근 방식을 설명합니다.

## 문제점: k6에서 10,000 VU 초기화 실패

k6는 가상 사용자(VU)를 초기화하는 데 상당한 메모리를 사용합니다. 10,000명의 VU를 직접 만들려고 하면 다음과 같은 문제가 발생할 수 있습니다:
- VU 초기화 중 메모리 제한 도달
- VU 생성 중 프로세스 중단
- 도커 컨테이너 리소스 제한으로 인한 실패

## 해결 방법: 효율적인 부하 시뮬레이션

직접 10,000개의 VU를 생성하는 대신, 다음과 같은 접근 방식을 사용합니다:
1. 적은 수의 VU(최대 500개)로 테스트
2. 각 VU가 더 많은 메시지를 보내도록 구성
3. 메시지를 배치로 그룹화하여 처리
4. 도커 리소스 제한 최적화
5. 더 짧은 대기 시간으로 더 높은 처리량 생성

### 메시지 볼륨을 통한 10k 사용자 시뮬레이션

아래 표는 VU 수와 메시지 수를 조정하여 10,000명 사용자와 동등한 부하를 생성하는 방법을 보여줍니다:

| 메트릭 | 10,000 VU 직접 접근법 | 최적화된 500 VU 접근법 |
|-------|-------------------|-------------------|
| VU 수 | 10,000 | 500 |
| VU당 메시지 수 | 10 | 200 |
| 총 메시지 수 | 100,000 | 100,000 |
| 메모리 사용량 | ~40GB (비현실적) | ~4GB (현실적) |
| VU 초기화 시간 | ~10분 이상 (실패 위험) | ~30초 |
| 배치 처리 | 아니오 | 예 (10 메시지/배치) |
| 메시지/초 | ~1,000 | ~1,000+ |

이 방식을 사용하면 실제로 10,000명의 사용자가 생성하는 것과 유사한 네트워크 트래픽과 서버 부하를 생성할 수 있습니다.

## 최적화된 테스트 실행 방법

### 1. 고부하 테스트 스크립트 실행

```bash
cd k6-tests
./run-high-load-test.sh
```

이 스크립트는 기본적으로 `websocket-message-flood-test.js` 스크립트를 실행합니다.

### 2. 스크립트 옵션

다음 옵션을 사용하여 테스트를 사용자 지정할 수 있습니다:

```bash
./run-high-load-test.sh --script=custom-test.js --host=nginx --port=5002 --memory=8192
```

- `--script=파일명.js`: 사용자 지정 테스트 스크립트 실행 (기본값: websocket-message-flood-test.js)
- `--host=HOST`: API 호스트 지정 (기본값: nginx)
- `--port=PORT`: API 포트 지정 (기본값: 5002)
- `--memory=MB`: k6 컨테이너용 Node.js 최대 메모리 설정 (기본값: 8192MB)

### 3. 테스트 모니터링

테스트 실행 중 Grafana 대시보드를 통해 모니터링할 수 있습니다:
- http://localhost:3001

## 테스트 구성 파일 설명

### 1. websocket-message-flood-test.ts

이 테스트는 다음과 같은 방식으로 최적화되었습니다:
- VU 수를 500으로 제한
- 각 VU가 200개의 메시지를 10개씩 배치로 보냄
- 메시지 전송 사이의 지연 시간 최소화
- 배치 요청으로 처리량 증가

### 2. docker-compose-high-load.yml

이 파일은 고부하 테스트를 위해 최적화된 도커 설정을 포함합니다:
- k6 컨테이너에 더 많은 CPU 및 메모리 할당
- 파일 디스크립터 제한 증가
- 배치 처리 및 네트워크 최적화 설정
- 응답 본문 폐기로 메모리 사용량 감소

## 문제 해결

테스트 실행 중 문제가 발생하면 다음을 확인하세요:

1. **메모리 부족**: 도커에 할당된 메모리를 늘리세요.
   ```bash
   ./run-high-load-test.sh --memory=12288  # 12GB 메모리 할당
   ```

2. **CPU 제한**: 도커 설정에서 CPU 할당량을 확인하세요.

3. **네트워크 연결 제한**: 운영체제의 네트워크 연결 제한을 확인하세요.
   ```bash
   # Linux에서 임시 포트 범위 확인
   cat /proc/sys/net/ipv4/ip_local_port_range
   
   # macOS에서 설정 확인
   sysctl net.inet.ip.portrange
   ```

4. **로그 확인**: 자세한 오류 확인을 위해 로그 파일을 검토하세요.
   ```bash
   cat results/latest/k6_log_websocket-message-flood_*.txt
   ```

## 튜닝 팁

서버 성능에 따라 다음 매개변수를 조정하여 최적의 테스트를 구성할 수 있습니다:

1. **VU 수 vs 메시지 수**: VU 수는 줄이고 메시지 수를 늘리는 것이 더 효율적입니다.
2. **배치 크기**: 더 큰 배치는 처리량을 늘리지만 서버에 더 많은 부하를 줍니다.
3. **지연 시간**: 메시지 간 지연 시간을 조정하여 더 현실적인 사용자 동작을 시뮬레이션할 수 있습니다.
4. **테스트 지속 시간**: 단계별 테스트 기간을 조정하여 더 긴 부하 테스트를 실행하세요.

## 결론

이 접근 방식을 사용하면 실제로 10,000개의 VU를 생성하지 않고도 10,000명의 사용자와 동등한 부하를 생성할 수 있습니다. 각 VU가 더 많은 메시지를 보내고 배치 처리를 수행함으로써, 메모리 제한 내에서 효율적으로 고부하 테스트를 실행할 수 있습니다. 